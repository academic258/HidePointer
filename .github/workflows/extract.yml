# Automatically build the project and run any configured tests for every push
# and submitted pull request. This can help catch issues that only occur on
# certain platforms or Java versions, and provides a first line of defence
# against bad commits.

name: build
on: [pull_request, push]

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
      
      - name: Extract mod.zip and setup project
        run: |
          # æ£€æŸ¥mod.zipæ˜¯å¦å­˜åœ¨
          if [ ! -f "mod.zip" ]; then
            echo "âŒ Error: mod.zip not found in repository root!"
            echo "Available files in repository root:"
            ls -la
            exit 1
          fi
          
          echo "ğŸ“¦ Found mod.zip, starting extraction..."
          
          # æ˜¾ç¤ºzipæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“Š Zip file information:"
          unzip -l mod.zip | head -30
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºè§£å‹
          EXTRACT_DIR="extracted_project"
          mkdir -p "$EXTRACT_DIR"
          
          # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
          echo "ğŸš€ Extracting mod.zip to $EXTRACT_DIR..."
          unzip -q mod.zip -d "$EXTRACT_DIR"
          
          echo "ğŸ“ Contents of $EXTRACT_DIR:"
          ls -la "$EXTRACT_DIR/"
          
          # æ£€æŸ¥è§£å‹åçš„ç»“æ„
          # å¦‚æœè§£å‹ååªæœ‰ä¸€ä¸ªç›®å½•ï¼Œæˆ‘ä»¬å°†å…¶å†…å®¹ç§»åˆ°å½“å‰ç›®å½•
          # å¦åˆ™ï¼Œç›´æ¥å°†æ‰€æœ‰å†…å®¹ç§»åˆ°å½“å‰ç›®å½•
          cd "$EXTRACT_DIR"
          
          if [ $(ls -1 | wc -l) -eq 1 ] && [ -d "$(ls -1)" ]; then
            # åªæœ‰ä¸€ä¸ªç›®å½•çš„æƒ…å†µ
            SUBDIR="$(ls -1)"
            echo "ğŸ“ Found single directory: $SUBDIR"
            echo "ğŸ”„ Moving contents to repository root..."
            mv "$SUBDIR"/* ../ 2>/dev/null || true
            mv "$SUBDIR"/.* ../ 2>/dev/null || true
          else
            # å¤šä¸ªæ–‡ä»¶/ç›®å½•çš„æƒ…å†µ
            echo "ğŸ”„ Moving all extracted files to repository root..."
            mv * ../ 2>/dev/null || true
            mv .* ../ 2>/dev/null || true
          fi
          
          cd ..
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$EXTRACT_DIR"
          
          echo "âœ… Extraction complete!"
          echo "ğŸ“ Repository root after extraction:"
          ls -la
      
      - name: validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4
      
      - name: setup jdk
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'
      
      - name: make gradle wrapper executable
        run: |
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            echo "âœ… Gradle wrapper made executable"
          else
            echo "âš ï¸  No gradlew found, checking for build.gradle..."
            if [ -f "./build.gradle" ] || [ -f "./build.gradle.kts" ]; then
              echo "ğŸ“‹ Found Gradle build file but no wrapper"
            else
              echo "âŒ No Gradle build files found"
            fi
          fi
      
      - name: build
        run: |
          if [ -f "./gradlew" ]; then
            echo "ğŸš€ Building with Gradle wrapper..."
            ./gradlew build
          elif [ -f "./build.gradle" ] || [ -f "./build.gradle.kts" ]; then
            echo "ğŸš€ Building with system Gradle..."
            gradle build
          elif [ -f "./pom.xml" ]; then
            echo "ğŸš€ Building with Maven..."
            mvn clean compile
          else
            echo "âŒ No recognized build files found!"
            echo "Available files:"
            ls -la
            exit 1
          fi
      
      - name: capture build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: build/libs/
